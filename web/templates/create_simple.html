# extends "base_layout.html"
# block head
{{ super() }}
<script type="text/javascript" src="{{ url_for('static', filename='create_tournament.js') }}"></script> 
<script lang="javascript">
$(document).ready(
	function() 
    { 
       // $("#teamstable").tablesorter(); 
		$("#nav_create_simple").toggleClass("active");
		setGeneralTournamentPageLink("{{ url_for("tournament_view", id=0) }}");
		setSelectedTournamentTypeID({{ tournament_type.id }});
		setTournamentRunCount({{ run_count }});

		$("#rules > tbody > tr input").each(
			function (index, item)
			{
				$(item).change(function() { updateRuleSpiderChart(); });
			}
		);
		
		$("#custom_rule_constant").change(function() { updateCustomRuleChart(); });		
		updateRuleSpiderChart();
		updateCustomRuleChart();
    } 
);

function updateRuleSpiderChart()
{
	
	var labels = [];
	var dataset = {
		fillColor: "rgba(50, 50, 150, 0.5)",
		strokeColor: "rgba(0, 0, 50, 1.0)",
		pointColor: "rgba(25, 25, 100, 0.5)",
		pointStrokeColor: "rgba(0, 0, 0, 1)",
		data: []
	};
	var maxValue = 1.0;
	$("#rules > tbody > tr.rule_row").each(
		function (index, item)
		{
			var input_box = $(item).find("input");
			if (input_box == null) return;
			
			labels.push(input_box.attr("title"));
			var value = parseFloat(input_box.val());
			if (value > maxValue)
				maxValue = value;
			dataset.data.push(value);
		}
	);
	
	// replacing the canvas element seems necessary for certain mobile browsers..
	$('#rulecanvas').replaceWith('<canvas id="rulecanvas" width="300" height="300" style="float:left;"></canvas>');
	
	var canvas = document.getElementById("rulecanvas");
	var ctx = canvas.getContext("2d");
	var options = {
		scaleOverride: true,
		scaleStartValue: 0.0,
		scaleSteps: 3.0,
		scaleStepWidth: maxValue / 3.0
	};
	new Chart(ctx).Radar({labels: labels, datasets: [dataset]}, options);
}

function showCustomRule(id)
{
	
	$("#rule_row_" + id.toString()).show("fade");
	$("#custom_show_" + id.toString()).hide();
	showCustomTeamRatingsDialog(id)
}

function updateCustomRuleChart()
{
	var value = parseFloat($("#custom_rule_constant").val());
	var fun = function(x) { return 1.0 / (1.0  + Math.exp(-x/value)); }
	var labels = [];
	var data = [];
	for (var i = -100; i <= 100; i += 20)
	{
		labels.push(i);
		data.push(fun(i));
	}
	var data = {
		labels : labels,
		datasets : [
			{
				fillColor : "rgba(220,220,255,0.5)",
				strokeColor : "rgba(150,150,255,1)",
				pointColor : "rgba(100,100,200,1)",
				pointStrokeColor : "#fff",
				data : data
			}
		]
	};
	$('#customfunctioncanvas').replaceWith('<canvas id="customfunctioncanvas" width="300" height="300" style="float:left;"></canvas>');
	var canvas = document.getElementById("customfunctioncanvas");
	var ctx = canvas.getContext("2d");
	var options = {
		scaleOverride : true,
		scaleSteps : 10,
		scaleStepWidth : 0.1,
		scaleStartValue : 0.0,
		bezierCurve : false,
	};
	new Chart(ctx).Line(data, options);
}

function showCustomTeamRatingsDialog(id)
{
	$("#choose_teams_con").dialog(
	{
		//autoOpen: false,
		height: "auto",
		width: "auto",
		modal: true,
		title: "Set the custom ratings",
		buttons: 
			{
				 OK: function() { $( this ).dialog( "close" ); }
			}
	});
}

</script>
<style>
body {
	min-width:800px;
}

.rule_row {
	border-top: 2px solid grey;
}
div.ruletitle {
	margin:0px;
	margin-left:70px;
	margin-top:-5px;
}

td.ruletitle {
	width:25em;
}

.background {
	height:55px;
	position:absolute;
	margin-top:-20px;
	margin-left:-10px;
	padding-left:0px;
}

td.input {
	text-align:left;
	vertical-align:middle;
}

{{"#"}}choose_teams td,{{"#"}}choose_teams tr
{
	vertical-align:middle;
	padding:0px;
	padding-left:1em;
	padding-right:1em;
}

</style>
# endblock

# block contents
	<h1>New World Cup Run<small></small></h1>

	<div id="rule_selection_dialog">
	<table class="table table-hover tablesorter-green">
	</table></div>
	## The rule selection widget.
	<div class="selbox-con selbox-con-ok">
	<div class="headtab"><span>Rules</span></div>
	<div id="choose_rules" class="container selbox selbox-ok" style="pointer-events: auto;padding-bottom:0px;">
		<div class="headpart"><h2>Customize the rules<br><small>You can customize the weights of the different ranking rules and define how much influence they will have on the simulation.</small></h2>
		</div>
		<table style="width:100%"><tr>
		<td style="width:300px;"><canvas id="rulecanvas" width="300" height="300" style="float:left;"></canvas></td>
		<td style="vertical-align:middle;">
			<table id="rules" class="table table-hover" style="">
			<tbody>
			# for rule in rules
				<tr class="rule_row" id="rule_row_{{ rule.id }}" {% if rule.needs_custom_ratings %}style="display:none;"{% endif %}>
					<td class="ruletitle" style="background-image:url('');">
					<div class="background"><img src="{{ url_for('static', filename='img/rules/RuleBackground' ~ rule.name ~ '.png') }}"></div>
					<div class="ruletitle">
					<h5 style="padding:0px;margin:0px;"><strong>{{ rule.long_name }}</strong>
					<br><small>{{ rule.description }}</small></h5>
					</div></td>
					<td class="input"><input value="{{ rule.standard_weight }}" name="{{ rule.id }}" title="{{ rule.name }}">
					# if rule.needs_custom_ratings
					<span class="btn btn-primary" onclick="javascript:showCustomTeamRatingsDialog({{ rule.id }});" style="float:right;">adjust team ratings</span>
					# endif
					</td>
					
				</tr>
				# if rule.needs_custom_ratings
				<tr class="rule_show" id="custom_show_{{ rule.id }}">
					<td>&nbsp;</td>
					<td align="right"><span class="btn btn-primary" onclick="javascript:showCustomRule({{ rule.id }});">add custom rule</span></td>
					<td></td>
				</tr>
				# endif
			# endfor
			</tbody>
			</table>
		</td>
		</tr></table>
	</div>
	</div>
	
	## Teams will exist but will be hidden, this helps a streamlined creation API
	<div id="team_selection_dialog" style="display:none">
	<table class="table table-hover tablesorter-green">
	</table></div>
	
	<div class="selbox-con selbox-con-ok" id="choose_teams_con" style="display:none;padding:4em;">
	<div class="headtab"><span>Teams</span></div>
	<div id="choose_teams" class="container selbox selbox-info">
		<div>
		<h2>Setup Custom Ratings<br><small>This is for advanced users who want to try out an own rating strategy.</small></h2>
		<table style="width:100%"><tr>
		<td style="width:300px;"><canvas id="customfunctioncanvas" width="300" height="300" style="float:left;"></canvas></td>
		<td style="vertical-align:middle;text-align:left;">
		Please choose a normalization constant that will be used to calculate the win expectancy of two opposing teams.
		<div style="width:100%; background-color:#f0f0ff;padding:0.5em;">
		<math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
		<mstyle>
			<mtext>win expectancy</mtext>
			<mo>=</mo>
			<mrow>
				<mfrac>
				<mrow><mn>1</mn></mrow>
				<mrow>
					<mn>1</mn>
					<mo>+</mo>
					<msup>
						<mi>e</mi>
						<mrow><mo>-</mo>
						<mfrac>
							<mrow>
								<msub><mtext>rating</mtext><mn>1</mn></msub>
									<mo>-</mo>
								<msub><mtext>rating</mtext><mn>2</mn></msub>
							</mrow>
							<mrow>
							<mi>c</mi>
							</mrow>
						</mfrac></mrow>
					</msup>
	
				</mrow>
				</mfrac>
			</mrow>
		</mstyle>
		</math>
		</div>
		with c = <input value="10" id="custom_rule_constant" class="rule_parameter" data-type_id="{{ custom_score_rule['par_type'] }}">
		</td>
		</table>
		</div>
		<table id="teams" class="table table-hover tablesorter-green">
		<thead><tr><th>Number</th><th>Name</th><th>Rating</th><th>Country Code</th></tr></thead>
		<tbody>
		# for team in teams
			<tr>
			<td><span class="teamid">{{ team.id }}</span></td>
			<td>{{ team.name }}</td>
			<td class="input"><input value="100" title="Custom Rating" class="custom" data-score_type="{{ custom_score_rule['score_type'] }}">
			<td>{{ team.country_code }}<img style="border:1px solid black;float:right;" src="{{ url_for('static', filename='img/flags/'~team.country_code~'.png') }}"></td>
			</tr>
		# endfor
		</tbody>
		</table>
	</div>
	</div>
	
	## User confirmation before starting the tournament.
	<div class="selbox-con">
	<div class="headtab"><span>Run</span></div>
	<div id="finish_setup" class="container selbox selbox-info">
		<div class="headpart">
		<h2><small>This will simulate the complete tournament with your custom rules {{ run_count }} times.</small></h2>
		<div class="btn btn-success btn-lg" style="margin-bottom:0px; width:100%;" onclick="javascript:if (validateRuleSelection()) startTournament();">Start the Tournament Simulation</div>
		</div>
		<div id="goto_tournament" style="display:none;"><div class="info small"></div></div>
		<div id="starting_progressbar" style="width:100%;display:none;"></div>
	</div>
	</div>
# endblock